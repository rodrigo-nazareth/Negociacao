/******************************************************************************/
/***               Generated by IBExpert 13/04/2020 23:50:45                ***/
/******************************************************************************/

/******************************************************************************/
/***      Following SET SQL DIALECT is just for the Database Comparer       ***/
/******************************************************************************/
SET SQL DIALECT 3;



/******************************************************************************/
/***                                 Tables                                 ***/
/******************************************************************************/


CREATE GENERATOR GEN_PESSOAS_ID;

CREATE TABLE PESSOAS (
    PESSOA_ID      INTEGER NOT NULL,
    RAZAO_SOCIAL   VARCHAR(150) CHARACTER SET WIN1252 NOT NULL,
    NOME_FANTASIA  VARCHAR(50) CHARACTER SET WIN1252,
    CPF_CNPJ       VARCHAR(18) CHARACTER SET WIN1252 NOT NULL,
    TIPO_PESSOA    CHAR(3) CHARACTER SET WIN1252 NOT NULL
);




/* Check constraints definition */

ALTER TABLE PESSOAS ADD CONSTRAINT CK_TIPO_PESSOA CHECK (TIPO_PESSOA in('PRO', 'DIS'));


/******************************************************************************/
/***                              Primary Keys                              ***/
/******************************************************************************/

ALTER TABLE PESSOAS ADD CONSTRAINT PK_PESSOAS PRIMARY KEY (PESSOA_ID);


/******************************************************************************/
/***                                Indices                                 ***/
/******************************************************************************/

CREATE INDEX IDX_PESSOAS_ID ON PESSOAS (PESSOA_ID);


/******************************************************************************/
/***                                Triggers                                ***/
/******************************************************************************/


SET TERM ^ ;



/******************************************************************************/
/***                          Triggers for tables                           ***/
/******************************************************************************/



/* Trigger: PESSOAS_BD0 */
CREATE OR ALTER TRIGGER PESSOAS_BD0 FOR PESSOAS
ACTIVE BEFORE DELETE POSITION 0
AS
begin
  /* Trigger text */
  if (
    exists
    (
      select produtor_id from limites_credito_produtor
      where (produtor_id = old.pessoa_id)
    )
   ) then exception EXCLUSAO_PRODUTOR_LIMITE;

  if (
    exists
    (
      select distribuidor_id from limites_credito_produtor
      where (distribuidor_id = old.pessoa_id)
    )
   ) then exception EXCLUSAO_DISTRIB_LIMITE;

  if (
    exists
    (
      select produtor_id from negociacoes
      where (produtor_id = old.pessoa_id)
    )
   ) then exception EXCLUSAO_PRODUTOR_NEGOCI;

  if (
    exists
    (
      select distribuidor_id from negociacoes
      where (distribuidor_id = old.pessoa_id)
    )
   ) then exception EXCLUSAO_DISTRIBUID_NEGOCI;
end
^


/* Trigger: PESSOAS_BI */
CREATE OR ALTER TRIGGER PESSOAS_BI FOR PESSOAS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.pessoa_id is null) then
    new.pessoa_id = gen_id(gen_pessoas_id,1);
end
^


SET TERM ; ^



/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/

COMMENT ON TABLE PESSOAS IS 
'Definição da coluna TIPO_PESSOA:
PRO - Produtor
DIS - Distribuidor';



/******************************************************************************/
/***                               Privileges                               ***/
/******************************************************************************/
